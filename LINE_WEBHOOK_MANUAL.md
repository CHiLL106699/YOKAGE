# LINE Webhook 自動接收訊息功能操作手冊

## 📋 目錄
1. [功能概述](#功能概述)
2. [Webhook 設定流程](#webhook-設定流程)
3. [自動回覆規則管理](#自動回覆規則管理)
4. [事件日誌查詢](#事件日誌查詢)
5. [常見問題](#常見問題)

---

## 功能概述

**LINE Webhook 自動接收訊息功能**讓系統能夠即時接收客戶透過 LINE Bot 發送的訊息，並自動記錄至客戶互動歷史，同時支援自動回覆規則，提升客戶服務效率。

### 核心功能
- ✅ 自動接收 LINE 訊息（文字、圖片、貼圖、位置等）
- ✅ 自動記錄至客戶互動歷史
- ✅ 支援自動回覆規則（關鍵字、正則表達式）
- ✅ Webhook 事件日誌查詢
- ✅ 簽章驗證（確保訊息來源安全）

---

## Webhook 設定流程

### 步驟 1：取得 Webhook URL
系統提供的 Webhook URL 格式為：
```
https://your-domain.com/api/line/webhook
```

### 步驟 2：在 LINE Developers Console 設定 Webhook
1. 登入 [LINE Developers Console](https://developers.line.biz/console/)
2. 選擇您的 Messaging API Channel
3. 進入「Messaging API」分頁
4. 找到「Webhook settings」區塊
5. 點擊「Edit」，輸入 Webhook URL
6. 啟用「Use webhook」開關
7. 點擊「Verify」測試連線（應顯示 Success）

### 步驟 3：設定 Webhook 事件類型
在 LINE Developers Console 中，確保以下事件類型已啟用：
- ✅ Message events（訊息事件）
- ✅ Follow events（關注事件）
- ✅ Unfollow events（取消關注事件）

### 步驟 4：驗證 Webhook 正常運作
1. 使用 LINE App 掃描 Bot 的 QR Code 加為好友
2. 發送測試訊息（例如：「測試」）
3. 前往系統後台「LINE Webhook 管理」頁面
4. 查看「Webhook 事件日誌」，確認訊息已被接收

---

## 自動回覆規則管理

### 新增自動回覆規則

1. **進入管理頁面**
   - 路徑：`/dashboard/line-webhook`
   - 切換至「自動回覆規則」分頁

2. **點擊「新增規則」按鈕**

3. **填寫規則資訊**
   - **規則名稱**：例如「預約查詢自動回覆」
   - **規則說明**：簡述規則用途
   - **觸發類型**：
     - `關鍵字`：客戶訊息包含特定關鍵字時觸發
     - `正則表達式`：使用正則表達式匹配訊息
     - `總是回覆`：收到任何訊息都觸發
   - **觸發值**：
     - 關鍵字範例：`預約`、`查詢`、`取消`
     - 正則表達式範例：`^預約.*`（以「預約」開頭的訊息）
   - **優先級**：數字越大越優先（0-100）
   - **回覆類型**：
     - `純文字`：簡單的文字訊息
     - `Flex Message`：豐富的互動式訊息（需提供 JSON）
     - `模板訊息`：LINE 官方模板訊息
   - **回覆內容**：輸入回覆訊息內容

4. **點擊「新增」儲存規則**

### 編輯/刪除規則
- 點擊規則卡片右上角的「編輯」圖示可修改規則
- 點擊「刪除」圖示可刪除規則（需確認）

### 啟用/停用規則
- 點擊規則卡片右上角的「電源」圖示可切換啟用狀態
- 停用的規則不會觸發自動回覆

### 規則優先級
- 當多個規則同時匹配時，系統會選擇**優先級最高**的規則
- 建議將常用規則設定較高優先級

---

## 事件日誌查詢

### 查看 Webhook 事件
1. 進入「LINE Webhook 管理」頁面
2. 切換至「Webhook 事件」分頁
3. 查看所有接收到的事件記錄

### 事件資訊說明
- **事件類型**：message（訊息）、follow（關注）、unfollow（取消關注）
- **訊息類型**：text（文字）、image（圖片）、sticker（貼圖）、location（位置）
- **處理狀態**：已處理 / 未處理
- **建立時間**：事件接收時間

### 查看事件詳情
- 點擊事件卡片可查看完整的 Webhook Payload
- 包含訊息內容、來源資訊、Reply Token 等

---

## 常見問題

### Q1：Webhook 驗證失敗怎麼辦？
**A：** 請確認以下事項：
1. Webhook URL 是否正確（包含 `https://`）
2. 伺服器是否正常運作
3. LINE Channel Secret 是否正確設定

### Q2：為什麼客戶發送訊息後沒有自動回覆？
**A：** 請檢查：
1. 自動回覆規則是否已啟用
2. 觸發條件是否正確（關鍵字、正則表達式）
3. 規則優先級是否被其他規則覆蓋
4. 查看 Webhook 事件日誌，確認訊息是否被接收

### Q3：如何測試自動回覆規則？
**A：** 
1. 建立測試規則（例如：關鍵字「測試」）
2. 使用 LINE App 發送包含關鍵字的訊息
3. 查看 Webhook 事件日誌，確認事件已處理
4. 檢查 LINE App 是否收到自動回覆

### Q4：客戶訊息會自動記錄到哪裡？
**A：** 
- 所有客戶訊息會自動記錄至「客戶互動歷史」
- 可在「CRM Dashboard」→「客戶詳細資訊」→「互動歷史」分頁查看

### Q5：如何查看客戶的 LINE User ID？
**A：** 
1. 進入「CRM Dashboard」
2. 點擊客戶查看詳細資訊
3. 在客戶資料中可看到「LINE User ID」欄位

### Q6：Webhook 事件日誌會保留多久？
**A：** 
- 系統會保留所有 Webhook 事件記錄
- 建議定期清理舊資料以維持系統效能

---

## 技術支援

如有任何問題或需要協助，請聯繫系統管理員。

**文件版本**：v1.0  
**最後更新**：2026-02-01
